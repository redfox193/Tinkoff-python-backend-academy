[Вернуться][main]

# Подготовка Среды

На этом шаге подготовим среду разработки для приложения [FastAPI][fastapi].
Сначала создадим структуру директорий для приложения.
Затем поднимем виртуальное окружение и установим все зависимости проекта, необходимые для его работы.
Далее узнаем, как хранить переменные окружения вне кода и как загружать их в приложение.

---

## Создание структуры

Корневую директорию проекта можно назвать как угодно. Например, `url_shortener_project/`.
В настоящем случае это название репозитория - `python-hw-5-template`

Корневая директория будет являться вашим рабочим каталогом.
Команды для работы приложения будут выполняться из корневой директории, в которой вы сейчас находитесь.
Файлы и директории, которые вы будете создавать, будут находиться либо в этой директории,
либо в директории вашего приложения, которую вы создадите через некоторое время.

Имя директории проекта можно выбрать индивидуально, **но** важно назвать директорию приложения `shortener_app/`.
Находясь в директории проекта, создайте вложенную директорию `shortener_app/`:

```bash
mkdir shortener_app
```

Директория `shortener_app/` будет местом, в котором будет находиться ваше приложение. В дальнейшем вы будете добавлять
исходный
код приложения в различные файлы в этом каталоге `shortener_app/`.

Python-приложение для укорачивания URL будет представлять собой пакет с именем shortener_app, который будет содержать
различные модули. Чтобы использовать `shortener_app` в качестве пакета, создайте файл `__init__.py`:

```bash
touch shortener_app/__init__.py
```

Вы создаёте пакет, добавляя в каталог файл `__init__.py`. Файл `__init__.py` будет оставаться пустым на протяжении всего
семинара. Его единственная задача - сообщить `Python`, что каталог `shortener_app/` является пакетом.

> Примечание:
>
> Без файла `__init__.py` вы создадите не обычный пакет, а пакет пространства имён. Пакет пространства имён удобен при
> разбиении пакета на несколько каталогов, но в данном проекте разбиение пакета не предусмотрено.

---

## Добавление зависимостей

Зависимости - это пакеты `Python`, которые необходимы вашему проекту `FastAPI` для работы.
Перед их установкой с помощью `pip` (или `poetry`) целесообразно создать виртуальную среду.
Таким образом, вы устанавливаете зависимости не по всей системе, а только в виртуальной среде вашего проекта.

```bash
python3 -m venv venv
source venv/bin/activate
python -m pip --version
```

С помощью команд, показанных выше, создаём виртуальную среду с именем `venv`, используя встроенный в Python модуль
`venv`. Затем активирем её с помощью команды `source`. Круглые скобки, окружающие имя `(venv)`, означают, что
виртуальная среда успешно активирована.

После создания и активации виртуальной среды необходимо установить зависимости,
которые требуются будущему приложению для укорачивания URL:

```bash
python -m pip install fastapi==0.103.2 uvicorn==0.23.2
```

Для создания API вы будете использовать веб-фреймворк FastAPI.

Для работы API необходим веб-сервер. Именно для этого и предназначен `uvicorn`.
**Uvicorn** - это реализация веб-сервера для Python, предоставляющая асинхронный интерфейс шлюза сервера (Asynchronous
Server Gateway Interface - **ASGI**).
Шлюзовые интерфейсы веб-сервера (Web Server Gateway Interfaces - **WSGI**) определяют, как веб-сервер взаимодействует с
веб-приложением.

Традиционные реализации **WSGI**, такие как **Gunicorn**, требуют запуска нескольких процессов для одновременной
обработки
сетевого трафика. **ASGI**, напротив, может обрабатывать асинхронный цикл событий в одном потоке, если только вы сможете
избежать вызова блокирующих функций.

FastAPI опирается на стандарт **ASGI**, и используетcя веб-сервер **uvicorn**, который может работать с асинхронной
функциональностью. Но, как увидим на семинаре дальше, для использования **FastAPI** не обязательно писать асинхронный
код.

> Примечание:
>
> Если хотите узнать больше о том, как FastAPI работает с
> параллелизмом, то обратится к странице [Concurrency and async / await][fastapi] документации по FastAPI.

Установив веб-фреймворк и веб-сервер, добавим немного алхимии - `sqlalchemy`:

```bash
python -m pip install sqlalchemy==2.0.21
```

SQLAlchemy - это набор инструментов для работы с SQL на языке Python, который помогает взаимодействовать с базой данных.
Вместо того чтобы писать необработанные SQL-запросы, можно использовать объектно-реляционное отображение (ORM)
SQLAlchemy. ORM обеспечивает более удобный способ объявления взаимодействия вашего приложения и базы данных SQLite,
которую вы будете использовать.

Ваше приложение также будет опираться на переменные окружения. Более подробно о переменных окружения вы узнаете далее.
Пока же убедитесь, что установили python-dotenv, чтобы загружать их из внешнего файла:

```bash
python -m pip install python-dotenv==1.0.0
```

Пакет python-dotenv позволяет считывать пары ключ-значение из внешнего файла и задавать их в качестве переменных
окружения.

```bash
python -m pip install pydantic-settings==2.0.3
```

Наконец, вы воспользуетесь пакетом для проверки URL-адресов:

```bash
python -m pip install validators==0.22.0
```

Как следует из названия, библиотека validators помогает проверять такие значения, как адреса электронной почты,
IP-адреса или даже финские номера социального страхования. В вашем проекте вы будете использовать валидаторы для
проверки URL, который пользователь хочет сократить.

> Примечание:
>
> Команды `pip install`, приведённые выше, выделены, чтобы объяснить, почему они необходимы. Вы можете
> установить все зависимости одной командой, соединив имена пакетов в цепочку. Но ещё лучше использовать `poetry`

---

## Переменные окружения

В настоящее время вы разрабатываете своё приложения для сокращения URL на локальном компьютере.
Но когда вы захотите сделать его доступным для других пользователей, вы, возможно, захотите развернуть его в Интернете
или во внутренней сети организации.

Имеет смысл использовать различные настройки для разных сред. В локальной среде разработки может использоваться база
данных с другим именем, чем в продакшн среде.

Для гибкости эту информацию можно хранить в специальных переменных, которые можно настраивать для каждой среды.
Вы создадите приложение таким образом, чтобы в будущем его можно было развернуть, например в облаке.

Начните с создания файла `config.py` с настройками по умолчанию:

```python linenums="1"
# shortener_app/config.py

from pydantic_settings import BaseSettings


class Settings(BaseSettings):
    env_name: str = "Local"
    base_url: str = "http://localhost:8000"
    db_url: str = "sqlite:///./shortener.db"


def get_settings() -> Settings:
    settings = Settings()
    print(f"Loading settings for: {settings.env_name}")
    return settings
```

Вы установили pydantic автоматически при установке fastapi с помощью pip.
pydantic - это библиотека, использующая аннотацию типов для проверки данных и управления настройками.
В строке 3 вы импортируете `pydantic_settings` - дополнительная к pydantic библиотека для организации настроек.

Класс `Settings`, определенный в строке 5, является подклассом класса `BaseSettings`. Класс `BaseSettings` удобен для
определения переменных окружения в приложении. Вам нужно определить только те переменные, которые вы хотите
использовать, а обо всем остальном позаботится `pydantic`. Другими словами, не найдя соответствующих переменных
окружения, `pydantic` автоматически примет их значения по умолчанию.

В данном случае в строках 6-8 задаются настройки по умолчанию для `env_name`, `base_url` и `db_url`.
Позже вы замените их значения на внешние переменные окружения:

| Переменная настроек | Переменная окружения | Значение                      |
|---------------------|----------------------|-------------------------------|
| env_name            | ENV_NAME             | Имя вашего текущего окружения |
| base_url            | BASE_URL             | Домен вашего приложения       |
| db_url              | DB_URL               | Адрес вашей базы данных       |

Для начала неплохо иметь `env_name`, `base_url` и `db_url` со значениями по умолчанию. Но поскольку значения текущего
окружения, домена приложения и адреса базы данных зависят от окружения, в котором вы работаете, то позже вы загрузите
эти значения из внешних переменных окружения.

Чтобы вывести сообщение о загрузке настроек, в строках 10-13 создается функция `get_settings()`.
Функция `get_settings()` возвращает экземпляр класса `Settings` и предоставляет возможность кэширования настроек.
Но прежде чем разбираться, зачем нужно кэширование, запустите функцию `get_settings()` в интерактивном интерпретаторе
Python:

```python linenums="1"
from shortener_app.config import get_settings

get_settings().base_url
```

```
Loading settings for: Local
'http://localhost:8000'
```

```python linenums="1"
get_settings().db_url
```

```
Loading settings for: Local
'sqlite:///./shortener.db'
```

При вызове функции `get_settings()` настройки загружаются корректно.
Однако можно еще немного оптимизировать получение настроек.

> Примечание:
> Если при выполнении приведенных выше команд возникла ошибка, то необходимо убедиться, что интерактивный интерпретатор
> Python запускается из корневого каталога проекта:

Вы не меняете настройки приложения во время его работы. Тем не менее, при каждом вызове функции `get_settings()`
настройки
загружаются снова и снова. Но можно воспользоваться преимуществом того, что `get_settings()` является функцией, для
реализации стратегии наименьшего использования (Least Recently Used - **LRU**).

При запуске приложения имеет смысл загрузить настройки, а затем кэшировать данные. Кэширование - это техника
оптимизации, которую можно использовать в своих приложениях для сохранения в памяти последних или часто используемых
данных. Для достижения такого поведения можно реализовать стратегию кэширования LRU:

```python linenums="1"
# shortener_app/config.py

from functools import lru_cache

from pydantic_settings import BaseSettings


class Settings(BaseSettings):
    env_name: str = "Local"
    base_url: str = "http://localhost:8000"
    db_url: str = "sqlite:///./shortener.db"


@lru_cache
def get_settings() -> Settings:
    settings = Settings()
    print(f"Loading settings for: {settings.env_name}")
    return settings
```

В строке 3 вы импортируете `lru_cache` из модуля Python `functools`. Декоратор `@lru_cache` позволяет кэшировать
результат
выполнения функции `get_settings(`) с использованием стратегии `LRU`. Выполните приведенную ниже команду, чтобы увидеть,
как
работает кэширование:

```python linenums="1"
from shortener_app.config import get_settings

get_settings().base_url
```

```
Loading settings for: Local
'http://localhost:8000'
```

```python linenums="1"
get_settings().db_url
```

```
'sqlite:///./shortener.db'
```

Теперь вы видите сообщение `Loading settings for: Local` только один раз.
Это означает, что ваши настройки успешно кэшируются.
Добавив декоратор `@lru_cache`, вы сделали свое приложение более быстрым, снизив при этом нагрузку на вычислительные
ресурсы.

Еще одно улучшение, которое вам предстоит реализовать - это загрузка внешних переменных окружения. Начните с создания
внешнего файла `.env` в корневом каталоге вашего проекта, а затем добавьте в него следующее содержимое:

```
# .env

ENV_NAME="Development"
BASE_URL="http://127.0.0.1:8000"
DB_URL="sqlite:///./shortener.db"
```

Храня переменные окружения во внешнем пространстве, вы следуете двенадцатифакторной методологии создания приложений.
Двенадцатифакторная методология создания приложений содержит двенадцать принципов, позволяющих разработчикам создавать
переносимые и масштабируемые веб-приложения. Один из принципов заключается в хранении конфигурации приложения в среде:

> An app’s config is everything that is likely to vary between deploys (staging, production, developer environments,
> etc.). This includes:
>
> - Resource handles to the database, Memcached, and other backing services
> - Credentials to external services such as Amazon S3 or Twitter
> - Per-deploy values such as the canonical hostname for the deploy
>
> The twelve-factor principles require strict separation of config from code. Config varies substantially across
> deploys,
> and code does not. ([Source][12factor])

Рекомендуется иметь разные файлы `.env` для разных окружений. Кроме того, никогда не следует добавлять файл `.env`
в систему контроля версий, поскольку переменные окружения могут хранить конфиденциальную информацию.

> Примечание:
>
> Если вы делитесь своим кодом с другими разработчиками, то, возможно, захотите показать в своем репозитории, как должны
> выглядеть их `.env` файлы. В этом случае вы можете добавить `.env_template` в свою систему контроля версий.
> В `.env_template` можно хранить ключи со значениями `placeholder`. Чтобы помочь себе и своим коллегам-разработчикам,
> не забудьте написать в файле `README.md` инструкцию о том, как переименовать `.env_template` и хранить в нем
> правильные значения.

Конфигурационные переменные, которые вы использовали в классе `Settings`, являются запасными для переменных внешнего
окружения. В файле `.env` вы объявляете те же переменные для среды разработки. При развертывании приложения в продакшн
переменные окружения объявляются для каждой среды.

Чтобы загрузить внешний `.env`-файл, настройте класс `Settings` в файле `config.py`:

```python linenums="1"
# shortener_app/config.py

# ...

class Settings(BaseSettings):
    env_name: str = "Local"
    base_url: str = "http://localhost:8000"
    db_url: str = "sqlite:///./shortener.db"

    class Config:
        env_file = ".env"

# ...
```

При добавлении в настройки класса `Config` с путём к файлу `env_file` `pydantic` загружает переменные окружения из
файла `.env`. Протестируйте свои внешние переменные окружения, выполнив приведенные ниже команды:

```python linenums="1"
 get_settings().env_name
```

```
'Local'
```

Значения - те, которые объявили в файле `.env`
Теперь ваше приложение работает с внешними переменными.

---

## Настройки

Если вы следовали приведенным выше инструкциям, то ваше дерево каталогов должно выглядеть следующим образом:

```
url_shortener_project/
│
├── shortener_app/
│   │
│   ├── __init__.py
│   └── config.py
│
├── venv/
│
└── .env
```

Ваш каталог `url_shortener_project/` (или так как вы его назвали) содержит директорию `shortener_app/`.
Пока в ней есть только пустой файл `__init__.py` и файл `config.py`, в котором хранятся настройки вашего приложения.
Настройки можно загрузить из внешнего файла `.env`, созданного в корне каталога проекта.

Кроме того, у вас может быть папка `venv`, содержащая ваше виртуальное окружение. После создания структуры проекта можно
приступать к реализации основной функциональности приложения.

[Вернуться][main]

---

[main]: ../../README.md "содержание"

[fastapi]: https://fastapi.tiangolo.com/async/ "fastapi"

[12factor]: https://12factor.net/config "12factor config"
