[Вернуться][main]

# Развёртывание приложений и Контейнеризация

## Основы контейнеризации

Контейнеризация является одной из самых важных концепций разработки программного обеспечения в современных условиях. Это
метод связывания приложений и включения в них всех своих зависимостей, таких как библиотеки и другие ресурсы,
необходимые для их работы. Это позволяет запускать и управлять приложениями независимо от окружения.

## Введение в Docker и его использование в Python

**Docker** - это платформа для запуска контейнеров с готовыми приложениями. Это очень мощная система, которая особенно
популярна для упаковки и развертывания приложений и микросервисов.

Docker позволяет разработчикам упаковывать приложение с
его зависимостями в контейнер. Это позволяет приложению работать на любой машине и с любой операционной системой.

### Пример использования Docker в Python:

Docker доступен на всех основных операционных системах: Windows, macOS и Linux.
Если у вас нет особых потребностей, вы можете использовать Docker Engine - версию Community.

Сначала [установим Docker][install-docker].

### Запуск контейнеров

В Docker используются понятия образов и контейнеров. Образ - это автономный пакет, который может быть запущен Docker.
Контейнер - это запущенный образ с определенным состоянием. Существует несколько репозиториев, содержащих готовые образы
Docker. [Docker Hub][docker-hub] - это репозиторий по умолчанию, который будет использоваться в данном руководстве. Для
первого
примера запустите образ hello-world:

```bash
docker run hello-world
```

В выводе будет что-то похожее на это:

```bash
Hello from Docker!
This message shows that your installation appears to be working correctly.
```

При запуске этого образа полученный контейнер выдает сообщение "Hello from Docker!", которое печатается в терминале.

## Dockerfile

Для создания собственных образов можно использовать Dockerfiles, представляющий собой текстовый файл, в котором
описывается, как должен быть настроен образ Docker. Ниже приведен пример [Dockerfile][Dockerfile]:

```Dockerfile
FROM ubuntu
RUN apt update && apt install -y cowsay
CMD ["/usr/games/cowsay", "Dockerfiles are cool!"]
```

Dockerfile состоит из списка команд Docker. В приведенном примере есть три шага:

- Строка 1 основывает образ на существующем образе [ubuntu][ubuntu]. Это можно сделать независимо от того, на какой
  системе запущен Docker.
- В строке 2 устанавливается программа [cowsay][cowsay].
- В строке 3 подготавливается команда, которая запускает cowsay при выполнении образа.

Чтобы использовать этот `Dockerfile`, сохраните его в текстовом файле с именем Dockerfile без расширения.

> [:information_source: Примечание]  
> Образы Linux можно создавать и запускать на любой платформе, поэтому такие образы, как ubuntu, отлично подходят для
> создания приложений, которые должны быть кроссплатформенными.
>
> В отличие от этого, образ Windows будет работать только под Windows, а образ macOS - только под macOS.

Затем создайте образ из своего Dockerfile:

```bash
docker build -t cowsay docker
```

В процессе создания образа команда выдаст большое количество результатов. `-t cowsay` пометит образ именем
`cowsay`. Вы можете использовать теги для отслеживания своих образов.

Последнее слово `docker` в команде указывает на
директорию в которой находится `Dockerfile`, В случае если запуск происходит из директории в которой
находится `Dockerfile`
то вместо указания директории необходимо указать символ точка: `.`

Теперь, когда образ успешно собран, вы можете запустить свой собственный образ Docker:

```bash
docker run --rm cowsay
```

Флаг `--rm` очищает контейнер после использования. Использование опции `--rm` является хорошей практикой, чтобы не
захламлять систему устаревшими контейнерами Docker.

## Практика создания Docker контейнера для Python приложения

> [:information_source: Примечание]
> В Docker имеется несколько команд для управления образами и контейнерами. Список образов и контейнеров можно получить
> с помощью команд docker images и docker ps -a, соответственно.
>
> Образам и контейнерам присваивается 12-символьный идентификатор, который можно найти в этих списках. Для удаления
> образа или контейнера используйте команду docker rmi <image_id> или docker rm <container_id> с правильным
> идентификатором.

<details><summary>Полезные команды</summary>

Список контейнеров:

```bash
docker ps
```

Список контейнеров, включая остановленные:

```bash
docker ps -a
```

Список образов:

```bash
docker images
```

Остановка контейнера:

```bash
docker stop <container id>
```

Удаление остановленного контейнера:

```bash
docker rm <container id>
```

Удаление всех остановленных контейнеров:

```bash
docker rm $(docker ps --filter status=exited -q)
```

Список всех запущенных сетей:

```bash
docker network ls
```

Удаление сети:

```bash
docker network rm <network id>
```

Удаление всех неиспользуемых образов (используйте аккуратно!):

```bash
docker image prune
```

</details>

Командная строка docker очень мощная.
Для получения дополнительной информации используйте команду `docker --help` и
официальную [документацию][docker-cli-doc].

Доп. пример:

Сборка образа :

```bash
docker build -f docker/Dockerfile.python3.9 -t py3-9 .
```

Запуск контейнера из собранного образа:

```bash
docker run --rm py3-9
```

Запуск тестов внутри контейнера:

```bash
docker run --rm -it py3-9 pytest 
```

Флаг `-it` -> interactive terminal

### Оркестрация контейнеров с помощью [Docker Compose][compose]

Большинство реальных приложений состоит из множества компонентов, которые, естественно, трансформируются в контейнеры
`Docker`. Например, несколько более сложное веб-приложение может иметь следующие компоненты:

- **Бэкенд (Back end)**: Django, FastAPI, Flask
- **Фронтенд (Front end)**: Angular, React, Vue
- **Кэш (Cache)**: Couchbase, Memcached, Redis
- **Очереди (Queue)**: ActiveMQ, Kafka, RabbitMQ
- **База данных(Database)**: MySQL, PostgreSQL, SQLite

Более крупные приложения могут разделить свои внутренние и внешние компоненты на еще большее количество микросервисов,
отвечающих за аутентификацию, управление пользователями, обработку заказов, платежей, обмен сообщениями и т.д.

Для управления и, в некоторой степени, оркестрации нескольких контейнеров Docker для таких приложений можно использовать
Docker Compose. Это инструмент, работающий поверх Docker и упрощающий запуск многоконтейнерных Docker-приложений. Docker
Compose позволяет определить приложение в терминах взаимозависимых сервисов, а также их конфигурацию и требования. Затем
он координирует их и запускает как одно целое приложение.

[Вернуться][main]

---

[main]: ../../README.md "содержание"

[install-docker]: https://docs.docker.com/get-docker/ "get-docker"

[docker-hub]: https://hub.docker.com "Build and Ship any Application Anywhere"

[Dockerfile]: ../../docker/Dockerfile "Dockerfile"

[ubuntu]: https://hub.docker.com/_/ubuntu "ubuntu image"

[cowsay]: https://en.wikipedia.org/wiki/Cowsay "Cowsay app"

[docker-cli-doc]: https://docs.docker.com/engine/reference/commandline/cli/ "Документация Docker cli"

[compose]: https://docs.docker.com/compose/ "Docker Compose"